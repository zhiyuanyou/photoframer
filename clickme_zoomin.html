<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoom-in Results of PhotoFramer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            margin-bottom: 0;
            display: none; /* hidden until a status is shown */
        }

        .controls h3 {
            margin-bottom: 15px;
            color: #4a5568;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .status.loading {
            background: #fef7cd;
            color: #b45309;
            display: block;
        }

        .status.error {
            background: #fecaca;
            color: #dc2626;
            display: block;
        }

        .status.success {
            background: #d1fae5;
            color: #059669;
            display: block;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-top: 20px;
        }

        .sample-card {
            background: white;
            border-radius: 15px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            min-height: auto;
        }

        .sample-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .sample-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f1f5f9;
            gap: 15px;
        }

        .sample-id {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
            word-break: break-all;
            line-height: 1.4;
            flex: 1;
            min-width: 0;
            position: relative;
            cursor: help;
        }

        .sample-id:hover::after {
            content: attr(title);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            white-space: pre-wrap;
            z-index: 10000;
            max-width: 80vw;
            word-break: break-all;
            line-height: 1.4;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .sample-id-truncated {
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .image-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .image-wrapper {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
        }

        .image-wrapper img {
            width: 100%;
            height: auto;
            object-fit: contain;
            transition: transform 0.3s;
            cursor: default;
            max-height: 300px;
        }

        .image-wrapper:hover img {
            transform: none;
        }

        .image-label {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .reason-container {
            background: #ffffff;
            color: #000000;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            margin-top: 20px;
        }

        .reason-title {
            font-weight: 600;
            color: #000000;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .reason-text {
            color: #2d3748;
            line-height: 1.6;
            font-size: 16px;
            white-space: pre-wrap;
        }

        .reason-embed {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .reason-iframe {
            width: 100%;
            height: 160px;
            border: 0;
            background: #fff;
        }

        .reason-input {
            width: 100%;
            min-height: 160px;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            resize: vertical;
            font-size: 16px;
            font-family: inherit;
            margin-top: 10px;
            line-height: 1.6;
            background: #ffffff;
            color: #000000;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }

        .modal-content {
            position: relative;
            margin: auto;
            padding: 0;
            width: 90%;
            max-width: 1200px;
            top: 50%;
            transform: translateY(-50%);
        }

        .modal img {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #667eea;
        }

        @media (max-width: 1200px) {
            .results-grid {
                grid-template-columns: 1fr;
                gap: 25px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .image-container {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }

            .sample-card {
                min-height: auto;
                padding: 20px;
            }

            .image-wrapper img {
                max-height: 250px;
            }

            .reason-input {
                min-height: 160px;
                font-size: 15px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¥¯ Zoom-in Results of PhotoFramer </h1>
        </div>

        <div class="controls">
            <div id="status" class="status"></div>
        </div>

        <div id="resultsContainer"></div>
    </div>

    <!-- Modal for full-size images -->
    <div id="imageModal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <div class="modal-content">
            <img id="modalImage" src="" alt="">
        </div>
    </div>

    <script>
        let currentResults = [];
        const DEFAULT_FOLDER = 'zoomin_samples';
        // Static manifest used when opened via file:// so no user action is needed
        const STATIC_SAMPLES = [
            "000000026529_x4_3x2_hltw_box-128-97-512-340_mos5.0",
            "000000053458_x4_4x3_hltw_box-0-170-352-425_mos5.0",
            "000000058726_x4_7x6_hltw_box-107-44-384-288_mos5.0",
            "000000060720_x4_4x3_hltw_box-64-144-400-384_mos5.0",
            "000000067440_x4_7x6_hltw_box-18-170-317-422_mos5.0",
            "000000133947_x4_4x3_hgtw_box-54-96-286-415_mos5.0",
            "000000165717_x4_4x3_hltw_box-192-48-576-336_mos5.0",
            "000000190204_x4_3x2_hltw_box-128-84-511-341_mos5.0",
            "000000340247_x4_3x2_hltw_box-122-138-468-360_mos5.0",
            "000000354949_x4_3x2_hltw_box-50-30-379-254_mos5.0",
            "000000402885_x4_4x3_hltw_box-56-85-382-340_mos5.0",
            "000000441875_x4_3x2_hgtw_box-131-77-420-512_mos5.0",
            "000000472024_x4_4x3_hltw_box-112-116-512-422_mos5.0",
            "000000524187_x4_7x6_hltw_box-66-0-448-336_mos5.0",
            "000000532631_x4_1x1_box-136-7-367-238_mos5.0",
            "000000536950_x4_1x1_box-39-256-300-511_mos5.0",
            "000000544780_x4_3x2_hltw_box-12-136-319-336_mos5.0",
            "000000570255_x4_7x6_hltw_box-182-88-443-303_mos5.0",
            "coco_obj_1_COCO_train2014_000000051512_x4_4x3_hgtw_box-84-168-340-509_mos4.61",
            "coco_obj_1_COCO_train2014_000000065515_x4_4x3_hgtw_box-204-0-491-384_mos5.0",
            "coco_obj_1_COCO_train2014_000000145503_x4_4x3_hltw_box-148-0-448-225_mos5.0",
            "coco_obj_1_COCO_train2014_000000251938_x4_4x3_hltw_box-175-70-462-285_mos4.64",
            "coco_obj_1_COCO_train2014_000000290849_x4_16x9_hltw_box-144-240-528-456_mos4.56",
            "coco_obj_1_COCO_train2014_000000496959_x4_16x9_hltw_box-195-117-579-332_mos5.0",
            "coco_obj_2_COCO_train2014_000000126959_x4_4x3_hltw_box-147-13-595-349_mos4.02",
            "coco_obj_3_COCO_train2014_000000571160_x4_4x3_hltw_box-126-84-466-339_mos5.0",
            "k40k_obj_0_farm1_37_78247431_8fd243ad14_x4_16x9_hltw_box-0-148-300-316_mos4.02",
            "k40k_obj_0_farm3_2428_4080534976_71bd8a1c1b_x4_4x3_hltw_box-233-99-500-299_mos4.17",
            "k40k_obj_1_farm8_7661_26958066653_3edf3c3d04_b_x4_16x9_hltw_box-0-224-602-563_mos4.14",
            "k40k_obj_2_farm2_1053_1169303250_48f1cb98ea_x4_4x3_hgtw_box-37-148-262-448_mos4.48",
        ];

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            const controls = document.querySelector('.controls');
            if (controls) controls.style.display = 'block';
        }

        function hideStatus() {
            const status = document.getElementById('status');
            status.style.display = 'none';
            const controls = document.querySelector('.controls');
            if (controls) controls.style.display = 'none';
        }

        // -------- Auto scan server directory (shift_samples) ----------
        async function listFilesInDirectory(dirPath) {
            const url = dirPath.endsWith('/') ? dirPath : dirPath + '/';
            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) {
                throw new Error(`Failed to fetch directory: ${dirPath} (${res.status})`);
            }
            const text = await res.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            const anchors = Array.from(doc.querySelectorAll('a'));
            const files = anchors
                .map(a => a.getAttribute('href'))
                .filter(href => !!href && !href.endsWith('../') && !href.endsWith('/'))
                .map(name => ({
                    name: decodeURIComponent(name),
                    url: url + name
                }));
            return files;
        }

        async function autoDiscoverFromDirectory(dirPath) {
            const files = await listFilesInDirectory(dirPath);
            const sampleIds = new Set();
            const origPattern = /(.+)_orig\.jpg$/;
            files.forEach(f => {
                const m = f.name.match(origPattern);
                if (m) sampleIds.add(m[1]);
            });
            const sortedIds = Array.from(sampleIds).sort();
            return { files, sampleIds: sortedIds };
        }

        async function buildResultsFromDirectory(sampleIds, dirPath, files) {
            const nameToUrl = new Map(files.map(f => [f.name, f.url]));
            const results = [];
            for (const sampleId of sampleIds) {
                let baseId = sampleId;
                let origUrl = nameToUrl.get(`${baseId}_orig.jpg`);
                let editUrl = nameToUrl.get(`${baseId}_edit.jpg`);
                let reasonUrl = nameToUrl.get(`${baseId}_reason.txt`);

                if ((!origUrl || !editUrl) && sampleId.includes('_rot')) {
                    const noRot = sampleId.replace(/_rot[\d.]+$/, '');
                    origUrl = nameToUrl.get(`${noRot}_orig.jpg`) || origUrl;
                    editUrl = nameToUrl.get(`${noRot}_edit.jpg`) || editUrl;
                    reasonUrl = nameToUrl.get(`${noRot}_reason.txt`) || reasonUrl;
                    baseId = noRot;
                }

                if ((!origUrl || !editUrl) && !sampleId.includes('_rot')) {
                    const prefix = `${sampleId}_rot`;
                    const rotOrig = files.find(f => f.name.startsWith(prefix) && f.name.endsWith('_orig.jpg'));
                    if (rotOrig) {
                        const rotId = rotOrig.name.replace('_orig.jpg', '');
                        origUrl = nameToUrl.get(`${rotId}_orig.jpg`);
                        editUrl = nameToUrl.get(`${rotId}_edit.jpg`);
                        reasonUrl = nameToUrl.get(`${rotId}_reason.txt`);
                        baseId = rotId;
                    }
                }

                if (origUrl || editUrl) {
                    results.push({
                        id: baseId,
                        origPath: origUrl || null,
                        editPath: editUrl || null,
                        reasonUrl: reasonUrl || null,
                        reason: ''
                    });
                }
            }
            return results;
        }

        async function autoLoadShiftSamples() {
            try {
                // If opened as a local file, use static manifest so no clicks are needed
                if (location.protocol === 'file:') {
                    const sampleIds = STATIC_SAMPLES.slice();
                    const results = sampleIds.map(id => {
                        const makeUrl = (suffix) => `${DEFAULT_FOLDER}/${encodeURIComponent(id + suffix)}`;
                        return {
                            id,
                            origPath: makeUrl('_orig.jpg'),
                            editPath: makeUrl('_edit.jpg'),
                            reasonUrl: makeUrl('_reason.txt'),
                            reason: ''
                        };
                    });
                    currentResults = results;
                    displayResults(results);
                    return;
                }

                const { files, sampleIds } = await autoDiscoverFromDirectory(DEFAULT_FOLDER);
                if (sampleIds.length === 0) {
                    showStatus(`No valid samples found in "${DEFAULT_FOLDER}"`, 'error');
                    return;
                }
                const results = await buildResultsFromDirectory(sampleIds, DEFAULT_FOLDER, files);
                currentResults = results;
                displayResults(results);
            } catch (e) {
                // On http(s) failure, inform gracefully
                showStatus(`Auto-load failed: ${e.message}`, 'error');
            }
        }

        function displayResults(results) {
            const resultsHtml = results.map(sample => {
                // Truncate very long IDs for display, but keep full ID in tooltip
                const displayId = sample.id.length > 15 ? 
                    `${sample.id.substring(0, 12)}...` : 
                    sample.id;
                
                const isFile = location.protocol === 'file:';
                const reasonBlock = (isFile && sample.reasonUrl)
                    ? `
                        <div class="reason-container">
                            <div class="reason-title">Text Guidance</div>
                            <div class="reason-embed">
                                <iframe class="reason-iframe" src="${sample.reasonUrl}" loading="lazy"></iframe>
                            </div>
                        </div>
                      `
                    : `
                        <div class="reason-container">
                            <div class="reason-title">Text Guidance</div>
                            <textarea class="reason-input" 
                                      id="reason-${sample.id}" 
                                      placeholder="Load reason from file or enter manually..."
                                      onchange="updateSampleReason('${sample.id}', this.value)"></textarea>
                        </div>
                      `;

                return `
                <div class="sample-card">
                    <div class="sample-header">
                        <div class="sample-id" title="Full ID: ${sample.id}">Sample ${displayId}</div>
                    </div>
                    <div class="image-container">
                        <div class="image-wrapper">
                            <img src="${sample.origPath || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmY3ODc4Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vdCBGb3VuZDwvdGV4dD48L3N2Zz4='}" alt="Original ${sample.id}">
                            <div class="image-label">Input</div>
                        </div>
                        <div class="image-wrapper">
                            <img src="${sample.editPath || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZmY3ODc4Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vdCBGb3VuZDwvdGV4dD48L3N2Zz4='}" alt="Edited ${sample.id}">
                            <div class="image-label">Result</div>
                        </div>
                    </div>
                    ${reasonBlock}
                </div>
                `;
            }).join('');

            document.getElementById('resultsContainer').innerHTML = `
                <div class="results-grid">
                    ${resultsHtml}
                </div>
            `;

            // Load reason texts from URLs (skip fetch in file:// mode)
            results.forEach(sample => {
                if (sample.reasonUrl && location.protocol !== 'file:') {
                    loadReasonFromUrl(sample.id, sample.reasonUrl);
                }
            });
        }

        async function loadReasonFromUrl(sampleId, url) {
            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) return;
                const content = await res.text();
                const textarea = document.getElementById(`reason-${sampleId}`);
                if (textarea) {
                    textarea.value = content;
                    updateSampleReason(sampleId, content);
                }
            } catch (e) {
                // ignore
            }
        }

        function updateSampleReason(sampleId, reason) {
            const sample = currentResults.find(s => s.id === sampleId);
            if (sample) {
                sample.reason = reason;
            }
        }

        function openModal(imagePath) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = imagePath;
        }

        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // Close modal when clicking outside the image
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        // Page load initialization
        window.onload = function() {
            autoLoadShiftSamples();
        };
    </script>
</body>
</html> 